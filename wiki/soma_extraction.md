# soma_extraction.py

**Location:** `utils/module_3d/soma_extraction.py`

## Overview
Implements **Step 3: Soma Extraction**.
This is a **Detection** step, not a segmentation step. The goal is to identify the "Seed" or "Center" of every distinct cell body. These seeds are the anchor points used to split touching cells in Step 4.

## The Algorithm: "Iterative Peeling"

### 1. Classification
*   Objects in the binary mask are analyzed for volume.
*   **Small Objects:** Assumed to be single cells. Their coordinates are added to the seed list immediately.
*   **Large Objects:** Assumed to be clumps of touching cells. These are passed to the Peeling algorithm.

### 2. Distance Peeling (Erosion)
*   For a large object, we calculate its Distance Transform (DT).
*   We threshold this DT at various ratios (e.g., "Keep only pixels > 50% of max thickness").
*   This effectively "peels" away the thin processes, leaving only the thickest cores.

### 3. Intensity Peeling
*   We also threshold the *Intensity* image inside the object (e.g., "Keep top 10% brightest pixels").
*   This helps separate cells that are spatially fused but have distinct, bright nuclei/somas.

### 4. Candidate Filtering
*   Every fragment generated by peeling is tested against strict geometric rules:
    *   **Volume:** Is it big enough to be a nucleus?
    *   **Thickness:** Is it thick enough (spherical) vs. thin (process)?
    *   **Aspect Ratio:** Is it round-ish or a long line?
*   Valid fragments become **Seeds**.

## Memory Management
*   **Local Crops:** The function `extract_soma_masks` iterates through large objects one by one. It crops the Region of Interest (ROI) for that object, processes it in RAM, and writes the result to the global mask. This ensures we never process the whole volume's DT at once.

---

## Parameter Tuning Guide

### 1. Controlling the "Peeling" (Finding seeds in clumps)
These parameters determine how aggressively we try to break clumps apart.

*   **`ratios_to_process`** (List of floats, e.g., `[0.3, 0.5, 0.7]`)
    *   **What it does:** Distance thresholds. `0.7` means "Erode until only the inner 30% thickness remains."
    *   **Dense Aggregates:** Add **Higher Values** (e.g., `0.8`). You need aggressive erosion to separate fused somas.
    *   **Thin/Ramified Cells:** Use **Lower Values** (e.g., `0.2`, `0.3`). High values might make small somas disappear completely.

*   **`erosion_iterations`** (Integer)
    *   **What it does:** Applies binary erosion to the seeds *after* peeling.
    *   **Usage:** Use `1` or `2` if you have very thick connections (necks) between cells that simple peeling isn't breaking.

*   **`min_physical_peak_separation`** (Microns)
    *   **What it does:** If two seeds are found closer than this distance, they are merged into one.
    *   **Tuning:** Set to roughly the radius of a cell body (~7.0 um). If you see **multiple seeds inside one cell**, **increase** this.

### 2. Filtering Artifacts (Rejecting bad seeds)
Once a potential seed is found, is it a real cell?

*   **`absolute_min_thickness_um`** (Microns)
    *   **Concept:** Somas are spheres; processes are tubes. Spheres are thicker.
    *   **Symptom: Long dendrites are being detected as Somas.** -> **Increase** this (e.g., to 2.5 or 3.0). This forces the seed to be "fat."

*   **`max_allowed_core_aspect_ratio`** (Float)
    *   **Concept:** Somas are roughly spherical (Ratio 1.0). Lines are elongated (Ratio > 5.0).
    *   **Symptom: Linear/Tubular structures detected as somas.** -> **Decrease** this (e.g., to 3.0).

*   **`min_fragment_size`** (Voxels)
    *   **Symptom: Noise/Speckles detected as cells.** -> **Increase**.