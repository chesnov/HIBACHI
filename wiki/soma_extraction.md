# Step 3: Soma Extraction (Seed Detection)

**Corresponding Modules:**
*   **3D:** `utils/module_3d/soma_extraction.py`
*   **2D:** `utils/ramified_module_2d/soma_extraction_2d.py`

## Overview
This is a **Detection** step, not a segmentation step. Its sole purpose is to identify the "Seed" or "Center" of every distinct cell body (soma) within the binary mask created in Steps 1 & 2.

These seeds serve as the anchor points for **Step 4 (Cell Separation)**. If Step 3 finds two seeds inside one large blob, Step 4 will split that blob into two cells. If Step 3 finds only one seed, the blob remains merged.

### The Algorithm: "Iterative Peeling"

1.  **Classification:**
    *   The algorithm analyzes the size distribution of all objects.
    *   **Small Objects:** Are assumed to be single cells. Their centroids are added to the seed list immediately.
    *   **Large Objects:** Are assumed to be clumps of touching cells. These are passed to the Peeling algorithm.

2.  **Distance Peeling (Morphological Erosion):**
    *   For a large object, we calculate its **Distance Transform (DT)** (distance from the pixel to the nearest background pixel).
    *   We threshold this DT at various **Ratios** (e.g., "Keep pixels that are > 50% of the max thickness").
    *   This effectively "peels" away the thin processes, leaving only the thickest cores.

3.  **Intensity Peeling:**
    *   We also threshold the **Intensity** image inside the object (e.g., "Keep the top 10% brightest pixels").
    *   This helps separate cells that are spatially fused (touching) but have distinct, bright nuclei.

4.  **Candidate Filtering:**
    *   Every fragment generated by peeling is tested against strict geometric rules to decide if it is a real soma or just a thick branch:
        *   **Size:** Is it big enough?
        *   **Thickness:** Is it thick enough (spherical) vs. thin (tubular)?
        *   **Aspect Ratio:** Is it round-ish (soma) or a long line (dendrite)?

5.  **Global Placement:**
    *   Valid seeds are placed into the final mask.
    *   A **Proximity Check** ensures no two seeds are placed closer than `min_physical_peak_separation`, preventing duplicate detections for the same cell.

---

## ðŸ”§ Parameter Tuning Guide

### 1. `ratios_to_process`
**Type:** List of Floats (0.0 - 1.0) | **Default:** `[0.3, 0.4, 0.5, 0.6]`

*   **High Level:** How aggressively to peel layers off the cell to find the core.
*   **Detailed Explanation:** A value of `0.7` means "Erode the object until only the inner 30% (thickest part) remains."
*   **How to Tune:**
    *   **Scenario A: Fused cells are not splitting.**
        *   *Fix:* Add **Higher Values** (e.g., `0.7`, `0.8`). You need deeper erosion to break the "neck" connecting the cells.
    *   **Scenario B: Small/Faint somas are disappearing.**
        *   *Fix:* Add **Lower Values** (e.g., `0.2`, `0.3`). High ratios might erode a small soma completely into nothingness.

### 2. `intensity_percentiles_to_process`
**Type:** List of Integers (0 - 100) | **Default:** `[100, 90, ..., 10]`

*   **High Level:** Finding cells based on brightness peaks.
*   **Detailed Explanation:** The algorithm thresholds the raw intensity at these percentiles to generate candidate seeds. `90` means "Check the top 10% brightest pixels."
*   **How to Tune:**
    *   **Scenario:** Your cells touch physically but have very bright, distinct nuclei.
        *   *Fix:* Ensure high values (e.g., `90`, `95`, `99`) are present.
    *   **Scenario:** Your cells have uneven staining (hollow centers).
        *   *Fix:* Rely less on this (remove high values) and more on `ratios_to_process` (geometry).

### 3. `min_physical_peak_separation`
**Type:** Float (Microns) | **Default:** ~5.0 - 10.0

*   **High Level:** The minimum allowed distance between two cell centers.
*   **Detailed Explanation:** If the algorithm finds two potential seeds that are closer than this distance, it assumes they belong to the same cell and merges them (or keeps only the best one).
*   **How to Tune:**
    *   **Standard:** Set to roughly the radius of a cell body (~5.0 - 7.0 um).
    *   **Scenario: A single cell is being split into multiple pieces.**
        *   *Fix:* **Increase** this value.
    *   **Scenario: Two tiny cells touching each other are counted as one.**
        *   *Fix:* **Decrease** this value.

### 4. `absolute_min_thickness_um`
**Type:** Float (Microns) | **Default:** ~1.5

*   **High Level:** Distinguishes "Spheres" (Somas) from "Tubes" (Processes).
*   **Detailed Explanation:** This measures the radius of the largest sphere that fits inside the candidate seed. Somas are fat; processes are thin.
*   **How to Tune:**
    *   **Scenario: Thick primary branches are being detected as cell bodies.**
        *   *Fix:* **Increase** this value (e.g., to `2.5` or `3.0`). This tells the tool: "If it's not at least 3um thick, it's not a soma."
    *   **Scenario: Very flat or small cells are missed.**
        *   *Fix:* **Decrease** this value.

### 5. `max_allowed_core_aspect_ratio`
**Type:** Float | **Default:** ~5.0 - 10.0

*   **High Level:** Shape filter.
*   **Detailed Explanation:** We run PCA on the candidate seed. `Ratio = Longest_Axis / Shortest_Axis`.
    *   Sphere â‰ˆ 1.0.
    *   Long Tube >> 1.0.
*   **How to Tune:**
    *   **Scenario: Long, tubular structures are detected as somas.**
        *   *Fix:* **Decrease** this (e.g., to `3.0`). This forces seeds to be round.

### 6. `min_fragment_size`
**Type:** Integer (Voxels/Pixels)

*   **High Level:** Noise rejection.
*   **Detailed Explanation:** Even after peeling, tiny artifactual specks might remain. This filters them out by raw volume/area.
*   **How to Tune:**
    *   **Scenario:** You see "dust" detected as cells.
        *   *Fix:* Increase this value.

### 7. `erosion_iterations`
**Type:** Integer | **Default:** 0

*   **High Level:** Helper for the peeling process.
*   **Detailed Explanation:** Applies standard binary erosion *after* the thresholding steps.
*   **How to Tune:**
    *   **Scenario:** Cells are connected by thick "necks" that `ratios_to_process` isn't breaking.
    *   *Fix:* Increase to `1` or `2`.

### 8. Reference Population Params (`ref_vol_percentile_...`)
**Type:** Integers

*   **High Level:** Automated tuning helpers.
*   **Detailed Explanation:** The algorithm measures all objects in the image to guess what a "Normal" cell looks like. These parameters control which range of cells (e.g., "Middle 50%") are used as the "Gold Standard" for calculating defaults if specific thresholds aren't met.
*   **Tuning:** Rarely needs changing. Default `30` (lower) and `70` (upper) works well to exclude debris (small) and clumps (large) from the reference stats.